<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>在线转码系统（网页版FFmpeg）</title>
    <meta name="description" content="在线转码工具（网页版FFmpeg）：在线音视频转码。通过浏览器轻松转换视频和音频格式。转码速度取决于您计算机的性能。推荐用于短视频和音频文件。项目已在GitHub上开源。">
    <link crossorigin="anonymous" rel="stylesheet" href="https://cdn.bootcss.com/element-ui/2.9.2/theme-chalk/index.css">
    <link rel="icon" href="favicon.ico" type="image/x-icon">
</head>
<body>
<div id="app" style="margin-left: 10%; margin-right: 10%;">
    <h1>在线转码系统（网页版FFmpeg）</h1>
    <el-row>
        <p>Language/语言:
            <el-link type="primary" href="index.html">English</el-link>
            <el-link type="primary" href="index_zh.html">中文</el-link>
        </p>
    </el-row>
    <h2>系统介绍</h2>
    <el-row>
        <p>视频音频格式随便转。</p>
        <p>使用浏览器转码，速度取决于你的电脑性能。仅推荐转短视频或音频，大型视频请使用专业软件转码。</p>
        <p>
            <el-link type="warning" href="advanced_zh.html">点击切换到专家模式</el-link>
        </p>
        <p>
            <el-link type="success" href="https://github.com/chn-lee-yumi/ffmpeg_on_browser">本项目在 GitHub 上开源</el-link>
        </p>
        <p>
            其它工具：
            <el-link type="success" href="https://tools.gcc.ac.cn/">https://tools.gcc.ac.cn/</el-link>
        </p>
    </el-row>
    <h2>转码参数</h2>
    <el-row>
        视频码率：
        <el-input placeholder="留空代表默认，示例值：2m, 1m, 512k" v-model="videoBitrate" style="width: 30%;"></el-input>
        （注：音频文件请留空）
    </el-row>
    <el-row>
        音频码率：
        <el-input placeholder="留空代表默认，示例值：128k, 96k" v-model="audioBitrate" style="width: 30%;"></el-input>
    </el-row>
    <el-row>
        输出文件名：
        <el-input placeholder="" v-model="outputName" style="width: 30%;"></el-input>
        （注：格式直接取决于文件名后缀，请勿和选择的文件同名）
    </el-row>
    <h2>开始转码</h2>
    <el-upload v-loading="loading" :on-change="handleFiles" :file-list="fileList" :auto-upload="false">
        <el-button size="big" type="primary">选择文件</el-button>
    </el-upload>
    <h2>系统输出</h2>
    <el-card class="box-card">
        <pre id="tty" style="white-space: pre-wrap; word-wrap: break-word;"></pre>
    </el-card>
</div>
</body>
<script crossorigin="anonymous" src="https://cdn.bootcss.com/vue/2.6.10/vue.min.js"></script>
<script crossorigin="anonymous" src="https://cdn.bootcss.com/element-ui/2.9.2/index.js"></script>
<script>
var worker = new Worker('worker.js');

worker.onmessage = function (event) {
	console.log(event)
	if(event.data.type=="tty"){
		var temp=document.getElementById("tty").innerHTML
		document.getElementById("tty").innerHTML=temp+"</br>"+event.data.value
		document.body.scrollTop=document.body.scrollHeight;
	} else if (event.data.type=="file"){
		setLoading(false)
		alert("转码完成！点击确定下载文件。")
		downloadFileByBlob(event.data.value,event.data.name)
	}
}

function downloadFileByBlob(blobUrl, filename) {
    const eleLink = document.createElement('a')
    eleLink.download = filename
    eleLink.style.display = 'none'
    eleLink.href = blobUrl
    document.body.appendChild(eleLink)
    eleLink.click()
    document.body.removeChild(eleLink)
}

new Vue({
  el: '#app',
  data: {
	  loading: false,
	  fileList: [],
	  videoBitrate: "",
	  audioBitrate: "",
	  mode: 0,
	  outputName: "output.mp4"
  },
  mounted:function (){
	  window.setLoading=this.setLoading
  },
  methods: {
    handleFiles: function (file, fileList) {
		this.loading=true
		console.log(file.name)
		console.log(this.videoBitrate,this.audioBitrate,this.outputName)
		worker.postMessage({
			"mode":this.mode,
			"fileList":[file.raw],
			"videoBitrate":this.videoBitrate,
			"audioBitrate":this.audioBitrate,
			"outputName":this.outputName})
    },
	setLoading: function (val){
		this.loading=val
		this.fileList=[]
	}
  }
})
</script>
</html>
